<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>PHILM Admin</title>
    <meta name="robots" content="noindex" />

    <!-- Viktigt: flagga manuell init så Decap inte försöker hämta config.yml -->
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>

    <!-- Netlify Identity (login/invite/reset) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js" defer></script>

    <!-- Pinna Decap till en stabil version -->
    <script src="https://unpkg.com/decap-cms@3.8.1/dist/decap-cms.js" defer></script>

    <style>
      /* Minimal fallback så man ser något om CMS inte initieras */
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      #cms-fallback { display: none; padding: 2rem; max-width: 42rem; margin: 10vh auto; }
      #cms-fallback.visible { display: block; }
      #cms-fallback code { background: #111; color: #eee; padding: 0.15rem 0.35rem; border-radius: 4px; }
    </style>
  </head>
  <body>
    <div id="cms-fallback">
      <h1>Admin</h1>
      <p>Om du ser den här rutan har CMS inte laddats korrekt.</p>
      <ol>
        <li>Ladda om sidan med hård refresh (<code>Ctrl/Cmd + Shift + R</code>).</li>
        <li>Kontrollera att Netlify Identity är aktiverat (Site settings → Identity).</li>
        <li>Se till att du är inbjuden användare och att Git Gateway är på.</li>
      </ol>
    </div>

    <script>
      // Kör först när både DOM och Decap-script är laddade.
      function initCMSWhenReady() {
        // decap-cms scripten lägger globalen "CMS"
        if (!window.CMS) {
          // prova igen strax om scriptet inte hunnit laddas
          return setTimeout(initCMSWhenReady, 50);
        }

        const config = {
          backend: { name: "git-gateway", branch: "main" },
          local_backend: false,
          load_config_file: false,  // ← absolut nyckel: försök inte hämta /admin/config.yml
          publish_mode: "editorial_workflow",
          media_folder: "src/uploads",
          public_folder: "/uploads",

          collections: [
            {
              name: "movies",
              label: "Movies",
              folder: "src/movies",
              create: true,
              extension: "md",
              format: "frontmatter",
              slug: "{{ slug }}",
              publish_permissions: { roles: ["admin", "editor", "default"] },
              fields: [
                { label: "Title", name: "title", widget: "string" },
                { label: "Tagline", name: "tagline", widget: "string", required: false },
                { label: "Date", name: "date", widget: "datetime", format: "YYYY-MM-DD" },
                { label: "Poster", name: "poster", widget: "image", required: false },
                { label: "Director", name: "director", widget: "string", required: false },
                { label: "Runtime", name: "runtime", widget: "string", required: false },
                { label: "Body", name: "body", widget: "markdown" }
              ],
              meta: {
                layout: { widget: "hidden", default: "layouts/movie.njk" }
              }
            },

            {
              name: "pages",
              label: "Pages",
              folder: "src/pages",
              create: true,
              extension: "njk",
              format: "frontmatter",
              slug: "{{ slug }}",
              publish_permissions: { roles: ["admin"] },
              fields: [
                { label: "Title", name: "title", widget: "string" },
                { label: "Body", name: "body", widget: "markdown" }
              ]
            },

            {
              name: "settings",
              label: "Settings",
              files: [
                {
                  label: "Site Settings",
                  name: "site",
                  file: "src/_data/site.json",
                  publish_permissions: { roles: ["admin"] },
                  fields: [
                    { label: "Site name", name: "name", widget: "string" },
                    { label: "Tagline / Description", name: "description", widget: "string" },
                    { label: "Theme", name: "theme", widget: "string", default: "dark" },
                    { label: "Hero Title", name: "heroTitle", widget: "string" },
                    { label: "Hero Subtitle", name: "heroSubtitle", widget: "string" },
                    { label: "Hero Button Text", name: "heroButtonText", widget: "string", default: "See schedule" },
                    { label: "Hero Background", name: "heroBg", widget: "image", required: false }
                  ]
                }
              ]
            }
          ]
        };

        try {
          CMS.init({ config });
        } catch (e) {
          console.error("CMS.init failed:", e);
          document.getElementById("cms-fallback").classList.add("visible");
        }

        // logga ev. Identity-fel
        if (window.netlifyIdentity) {
          window.netlifyIdentity.on("error", (err) => {
            console.error("Netlify Identity error:", err);
            document.getElementById("cms-fallback").classList.add("visible");
          });
        }
      }

      document.addEventListener("DOMContentLoaded", initCMSWhenReady);
    </script>
  </body>
</html>
